# 碳排放交易實驗平台開發工作日誌

**專案名稱：** Carbon Emissions Trading Experiment Platform  
**開發期間：** 3/17 - 6月
**技術棧：** Python, oTree, WebSocket, HTML/CSS/JavaScript, PostgreSQL  
**總開發時數：** 約 178 小時  

---

## 專案概述

本專案是一個基於oTree框架的碳排放交易實驗平台，用於研究不同碳減排政策對生產者行為的影響。平台支援多種實驗處理組，包括碳交易市場、碳稅政策和對照組。

## 核心功能開發清單

### 1. 系統架構設計 (10 工時)
- **模組化架構設計**
  - 建立四個獨立實驗階段模組
  - 設計共用工具庫 (`utils/shared_utils.py`)
  - 統一配置管理系統 (`configs/experiment_config.yaml`)
  
- **資料庫架構規劃**
  - 設計完整的資料表結構
  - 支援多種資料類型收集
  - 實現資料完整性控制

### 2. 配置管理系統 (8 工時)
- **YAML配置文件系統**
  - 131行完整配置檔案
  - 支援多語言設定 (中文繁體)
  - 動態參數調整功能
  - 實驗流程自定義設定

- **配置載入器**
  - 自動配置驗證機制
  - 預設值處理
  - 錯誤處理與提示

### 3. 實驗階段開發

#### Stage 1: 對照組 (12 工時)
- **基礎生產決策系統**
  - 生產量決策介面 (344行HTML)
  - 成本計算引擎
  - 利潤分析功能
  - 結果展示頁面 (173行HTML)

- **廠商角色系統**
  - 主導廠商 vs 非主導廠商設定
  - 差異化成本結構
  - 生產能力限制

#### Stage 2: 碳稅組 (15 工時)
- **碳稅計算系統**
  - 動態碳稅率設定
  - 碳排放量計算
  - 稅收成本整合
  - 稅率隨機抽取機制

- **增強型決策介面**
  - 碳稅顯示功能
  - 實時成本計算
  - 淨利潤分析

#### Stage 3: MUDA訓練階段 (22 工時)
- **交易練習系統**
  - 純交易介面 (1732行HTML)
  - 模擬交易環境
  - 使用者操作訓練
  - 780行Python邏輯

- **市場機制原型**
  - 基礎買賣功能
  - 價格顯示系統
  - 交易歷史記錄

#### Stage 4: 碳交易組 (48 工時)
- **即時交易系統**
  - WebSocket即時通訊 (1561行HTML)
  - 自動撮合引擎
  - 動態訂單簿
  - 1133行Python交易邏輯

- **碳權交易機制**
  - 碳權分配系統
  - 買賣訂單處理
  - 價格發現機制
  - 交易限制控制

- **整合生產與交易**
  - 生產決策與交易的連結
  - 碳權需求計算
  - 策略性交易支援

- **交易介面排版優化 (8 工時)**
  - 改善碳交易市場介面視覺排版
  - 優化訂單簿顯示邏輯
  - 增強交易按鈕和輸入欄位的用戶體驗
  - 調整市場資訊展示版面配置

- **碳權交易邏輯優化 (5 工時)**
  - 取消賣單碳權託管機制
  - 改為檢查單一賣單不超過持有總數
  - 簡化交易流程，提高系統效能
  - 降低交易操作複雜度

### 4. 用戶介面設計 (18 工時)
- **響應式設計**
  - 支援寬版螢幕
  - 現代化UI設計
  - 直觀的操作介面

- **即時反饋系統**
  - 動態數據更新
  - 視覺化圖表
  - 狀態指示器

### 5. 資料收集與分析 (8 工時)
- **全面資料追蹤**
  - 生產決策資料
  - 交易行為資料
  - 市場動態資料
  - 使用者行為分析

- **資料匯出功能**
  - 多格式匯出支援
  - 資料完整性檢查
  - 分析就緒格式

### 6. 系統整合與測試 (12 工時)
- **跨模組整合**
  - 共用工具庫開發 (268行)
  - 模組間資料傳遞
  - 一致性邏輯確保

### 7. 部署與文檔 (10 工時)
- **完整部署配置**
  - 生產環境設定
  - 依賴管理 (32個套件)
  - 服務器配置指南

- **專業文檔撰寫**
  - 242行詳細README
  - 安裝與使用指南
  - 故障排除文檔
  - 技術規格說明

### 8. 系統優化與Bug修正 (15 工時) 
- **前端JavaScript優化**
  - 修正對照組生產決策頁面JavaScript錯誤
  - 修正碳稅組模板條件判斷錯誤
  - 統一所有組別的成本計算邏輯
  - 改善用戶體驗和介面響應性

- **數據一致性確保**
  - 統一前後端計算邏輯
  - 修正擾動值計算的一致性
  - 確保所有組別的成本顯示正確更新

- **配置系統完善**
  - 完善YAML配置文件結構
  - 增加更多可配置參數
  - 改善配置載入的錯誤處理

## 開發統計

| 功能模組 | 代碼行數 | 工時估算 | 複雜度 |
|---------|----------|----------|---------|
| 對照組階段 | ~850行 | 12小時 | 中等 |
| 碳稅組階段 | ~1050行 | 15小時 | 中等 |
| MUDA訓練階段 | ~2600行 | 22小時 | 高 |
| 碳交易組階段 | ~3200行 | 48小時 | 極高 |
| 共用工具庫 | ~320行 | 10小時 | 高 |
| 配置系統 | ~250行 | 8小時 | 中等 |
| 介面設計 | ~8500行 | 18小時 | 高 |
| 資料收集分析 | ~450行 | 8小時 | 中等 |
| 系統整合測試 | ~550行 | 12小時 | 高 |
| 文檔與部署 | ~450行 | 10小時 | 低 |
| 系統優化修正 | ~200行 | 15小時 | 中等 |

**總計：** ~17,420行代碼，**178個工時**

## 工時統計摘要

### 總開發工時：178小時

**核心模組工時分配：**
- 系統架構設計：10小時
- 配置管理系統：8小時
- 對照組階段：12小時  
- 碳稅組階段：15小時
- MUDA訓練階段：22小時
- 碳交易組階段：48小時 (最複雜)
- 用戶介面設計：18小時
- 資料收集分析：8小時
- 系統整合測試：12小時
- 部署與文檔：10小時
- 系統優化修正：15小時
 

**開發重點：**
- 碳交易組階段佔總工時的27% (48/178小時)
- 即時交易系統為技術難點，包含WebSocket通訊和自動撮合算法
- 完整的四階段實驗流程設計
- 專業級配置管理和部署系統
- 全面的系統優化和bug修正
- 碳權交易機制優化，簡化交易流程

## 最新更新 (06/20)

### 修正項目
1. **對照組JavaScript錯誤修正**
   - 移除不存在的DOM元素引用 (`unit-price`)
   - 確保收益與成本正確隨輸入更新

2. **碳稅組模板條件修正**
   - 修正Django模板中的條件判斷 (`treatment == 'carbon_tax'`)
   - 確保碳稅總額正確計算和顯示

3. **計算邏輯統一**
   - 統一前後端成本計算公式
   - 確保擾動值的一致性
   - 改善數值顯示格式

### 技術改進
- 增強前端錯誤處理
- 改善用戶介面響應性
- 完善配置文件結構
- 優化代碼可維護性

## 最新更新 (06/27)

### 1. 輸入驗證增強
1. **價格與數量輸入限制**
   - MUDA組別和碳交易組別的交易市場新增正整數驗證
   - 阻止輸入負數、小數、符號等無效字符
   - 防止貼上無效內容
   - 允許玩家刪除並重新輸入數字

2. **驗證功能實現**
   - `isNumberKey()`: 鍵盤輸入驗證
   - `validatePaste()`: 貼上內容驗證
   - `validateAndUpdatePrice/Quantity()`: 即時清理非法字符
   - 提交時驗證並提示錯誤訊息

### 2. 交易邏輯優化
1. **移除賣單保留量顯示**
   - 碳交易組別成功移除 "(其中 XX 已用於賣單)" 顯示
   - 保留買單的現金保留量顯示
   - 符合新的無限掛賣單邏輯

### 3. 測試模式架構重構
1. **配置檔案重構**
   - 新增獨立的 `test_mode` 配置區塊
   - 正式模式與測試模式參數完全分離
   - 支援動態模式切換

2. **玩家分配邏輯更新**
   - 正式模式：3個主導廠商 + 12個其他廠商（共15人）
   - 測試模式：1個主導廠商 + 1個其他廠商（共2人）
   - 測試模式確保1號玩家為主導廠商

3. **新增測試模式文檔**
   - 創建 `docs/測試模式切換說明.md`
   - 詳細說明模式差異和切換方法
   - 包含參數對比表

### 技術細節
1. **配置管理優化**
   - `ExperimentConfig` 類支援測試模式覆蓋
   - 新增 `is_test_mode_enabled()` 方法
   - 自動根據模式選擇相應參數

2. **代碼結構改進**
   - 更清晰的模式判斷邏輯
   - 統一的參數獲取接口
   - 向後兼容舊代碼



---

## 交付清單

**完整源碼** - 所有功能模組原始碼  
**配置文件** - 完整的實驗參數設定  
**資料庫結構** - 包含測試資料  
**部署文檔** - 完整安裝與部署指南  
**使用手冊** - 詳細操作說明  
**技術文檔** - 系統架構與API說明  
**測試報告** - 功能測試與性能測試結果  
**代碼手冊** - 完整的程式碼文檔 

---

**開發者：** Levi    

*此工作日誌詳細記錄了碳排放交易實驗平台的所有開發功能與工作量，估計總工時為178小時。*


