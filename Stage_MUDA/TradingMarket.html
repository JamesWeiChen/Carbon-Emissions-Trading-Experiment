{% extends "global/Page.html" %}
{% load static %}

{% block title %}即時{{ item_name }}交易市場{% endblock %}

{% block content %}
<style>
    .otree-body {
        max-width: 70vw !important;
        padding-left: 0;
        padding-right: 0;
    }
    </style>

<div class="container-fluid">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2><i class="fas fa-exchange-alt"></i> 即時{{ item_name }}交易市場</h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4>您的資訊</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item">現金：<b id="cash">{{ cash }}</b></li>
                        <li class="list-group-item">{{ item_name }}持有：<b id="items">{{ items }}</b></li>
                        <li class="list-group-item">您的{{ item_name }}價值：<b>{{ personal_item_value }}</b> <small class="text-muted">(每單位)</small></li>
                        <li class="list-group-item">
                            總{{ item_name }}價值：<b id="total-item-value">{{ total_item_value }}</b>
                            <small class="text-muted d-block">= {{ personal_item_value }} × <span id="items-display">{{ items }}</span></small>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- 我的掛單區塊 -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h4>我的掛單</h4>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="myOrdersTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="my-buy-tab" data-toggle="tab" href="#my-buy-orders" role="tab">
                                我的買單
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="my-sell-tab" data-toggle="tab" href="#my-sell-orders" role="tab">
                                我的賣單
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content mt-2" id="myOrdersContent">
                        <!-- 我的買單 -->
                        <div class="tab-pane fade show active" id="my-buy-orders" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>單價</th><th>數量</th><th>總價格</th><th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-buy-orders-body">
                                        <!-- 我的買單數據會在JS中填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 我的賣單 -->
                        <div class="tab-pane fade" id="my-sell-orders" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>單價</th><th>數量</th><th>總價格</th><th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-sell-orders-body">
                                        <!-- 我的賣單數據會在JS中填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 最近交易記錄 -->
            <div class="card mt-3">
                <div class="card-header bg-secondary text-white">
                    <h4>最近交易記錄</h4>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm mb-0">
                            <thead class="bg-light sticky-top">
                                <tr>
                                    <th>時間</th><th>價格</th><th>數量</th><th>類型</th>
                                </tr>
                            </thead>
                            <tbody id="trade-history-body">
                                <!-- 交易記錄會在JS中填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>提交掛單</h4>
                </div>
                <div class="card-body">
                    <!-- 使用標準按鈕而非按鈕組 -->
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">買入／賣出：</label>
                        <div class="col-sm-9">
                            <div class="mb-2">
                                <button type="button" id="buy-btn" class="btn btn-primary mr-2" onclick="selectDirection('buy'); return false;">買入</button>
                                <button type="button" id="sell-btn" class="btn btn-outline-primary" onclick="selectDirection('sell'); return false;">賣出</button>
                                <input type="hidden" id="selected-direction" value="buy">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="price">價格：<span id="price-value">？</span> 法幣</label>
                        <div class="input-group mb-3">
                            <input type="number" id="price" class="form-control" min="1" step="1" value="" 
                                   placeholder="請輸入價格"
                                   oninput="validateAndUpdatePrice(this)" 
                                   onkeypress="return isNumberKey(event)"
                                   onpaste="return validatePaste(event, this)">
                            <div class="input-group-append">
                                <span class="input-group-text">法幣/單位</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="quantity">數量：<span id="quantity-value">？</span> 單位</label>
                        <div class="input-group mb-3">
                            <input type="number" id="quantity" class="form-control" min="1" step="1" value="" 
                                   placeholder="請輸入數量"
                                   oninput="validateAndUpdateQuantity(this)" 
                                   onkeypress="return isNumberKey(event)"
                                   onpaste="return validatePaste(event, this)">
                            <div class="input-group-append">
                                <span class="input-group-text">單位</span>
                            </div>
                        </div>
                    </div>

                    <!-- 總價格計算器 -->
                    <div class="form-group row">
                        <label class="col-sm-3 col-form-label">總價格：</label>
                        <div class="col-sm-9">
                            <div class="alert alert-info mb-0">
                                <span id="price-value-display">？</span> × <span id="quantity-value-display">？</span> = <strong id="total-price-display" class="text-muted font-weight-bold">？</strong>
                            </div>
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-sm-12 text-center">
                            <button type="button" id="submit-btn" class="btn btn-primary btn-lg" onclick="submitOffer(); return false;">
                                提交掛單
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 狀態通知區域 -->
            <div id="status-container" class="mb-3 mt-3"></div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h4>買單列表</h4>
                            <small class="text-white-50">想要購買{{ item_name }}的訂單</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="buy-offers">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>單價</th><th>數量</th><th>總價格</th><th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 買單數據會在JS中填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h4>賣單列表</h4>
                            <small class="text-white-50">想要出售{{ item_name }}的訂單</small>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="sell-offers">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>單價</th><th>數量</th><th>總價格</th><th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 賣單數據會在JS中填充 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 確保 Bootstrap 標籤頁正確運作
document.addEventListener('DOMContentLoaded', function() {
    // 手動綁定標籤頁點擊事件
    document.querySelectorAll('#myOrdersTabs .nav-link').forEach(function(tab) {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            
            // 移除所有標籤頁和內容區域的 active 狀態
            document.querySelectorAll('#myOrdersTabs .nav-link').forEach(function(t) {
                t.classList.remove('active');
            });
            document.querySelectorAll('#myOrdersContent .tab-pane').forEach(function(p) {
                p.classList.remove('show', 'active');
            });
            
            // 設置當前標籤頁和對應內容區域為 active
            this.classList.add('active');
            const target = this.getAttribute('href');
            document.querySelector(target).classList.add('show', 'active');
        });
    });
});

// Debug 模式開關
const DEBUG = true;

// 預防多重操作標誌
let isProcessingAction = false;

// 從模板傳入的參數
const playerId = {{ player_id }};
const personalItemValue = {{ personal_item_value }} || {{ market_price }};
let countdown = {{ timeout_seconds }};
let startTime = {{ start_time }};

// 如果 startTime 無效，則使用當前時間
if (typeof startTime === 'undefined' || isNaN(startTime)) {
    startTime = Math.floor(Date.now()/1000);
    log('警告：使用當前時間作為開始時間');
}

// 取得常用元素
const cdDisplay       = document.getElementById('countdown');
const statusContainer = document.getElementById('status-container');
const submitBtn       = document.getElementById('submit-btn');

/** 日誌函式 **/
function log(message) {
    if (!DEBUG) return;
    const ts = new Date().toLocaleTimeString();
    console.log(`[${ts}] ${message}`);
}

/** 切換買賣方向 **/
function selectDirection(dir) {
    document.getElementById('selected-direction').value = dir;
    const buyBtn  = document.getElementById('buy-btn');
    const sellBtn = document.getElementById('sell-btn');
    
    log(`切換交易方向: ${dir}`);
    
    if (dir === 'buy') {
        buyBtn.className  = 'btn btn-primary mr-2';
        sellBtn.className = 'btn btn-outline-primary';
    } else {
        buyBtn.className  = 'btn btn-outline-primary mr-2';
        sellBtn.className = 'btn btn-primary';
    }
    updateTotalPrice();
    return false;
}

/** 更新賣出按鈕狀態 **/
function updateSellButtonState() {
    const items  = parseInt(document.getElementById('items').innerText);
    const sellBtn = document.getElementById('sell-btn');
    if (items <= 0) {
        sellBtn.disabled = true;
        sellBtn.className = 'btn btn-outline-secondary';
        if (document.getElementById('selected-direction').value === 'sell') {
            selectDirection('buy');
        }
    } else {
        sellBtn.disabled = false;
        sellBtn.className = document.getElementById('selected-direction').value === 'sell'
            ? 'btn btn-primary' : 'btn btn-outline-primary';
    }
}

/** 顯示狀態通知 **/
function showStatus(message, type = 'info', duration = 0) {
    statusContainer.innerHTML = '';
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="return false;">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    statusContainer.appendChild(alert);
    if (duration > 0) {
        setTimeout(() => {
            try {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            } catch {}
        }, duration);
    }
    log(`狀態通知: [${type}] ${message}`);
}

/** 輸入驗證函數 **/
function isNumberKey(evt) {
    var charCode = (evt.which) ? evt.which : evt.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        return false;
    }
    return true;
}

function validatePaste(event, input) {
    event.preventDefault();
    const pasteData = (event.clipboardData || window.clipboardData).getData('text');
    if (/^\d+$/.test(pasteData) && parseInt(pasteData) > 0) {
        input.value = parseInt(pasteData);
        if (input.id === 'price') {
            validateAndUpdatePrice(input);
        } else if (input.id === 'quantity') {
            validateAndUpdateQuantity(input);
        }
    }
    return false;
}

function validateAndUpdatePrice(input) {
    let value = input.value;
    value = value.replace(/[^\d]/g, '');
    if (value === '0') {
        value = '';
    }
    if (value !== '') {
        const intValue = parseInt(value);
        if (intValue < 1) {
            value = '';
        } else {
            value = intValue.toString();
        }
    }
    input.value = value;
    updatePriceDisplay();
}

function validateAndUpdateQuantity(input) {
    let value = input.value;
    value = value.replace(/[^\d]/g, '');
    if (value === '0') {
        value = '';
    }
    if (value !== '') {
        const intValue = parseInt(value);
        if (intValue < 1) {
            value = '';
        } else {
            value = intValue.toString();
        }
    }
    input.value = value;
    updateQuantityDisplay();
}

/** 顯示與總價更新 **/
function updatePriceDisplay() {
    const priceInput = document.getElementById('price');
    const price = priceInput.value === '' ? '' : parseInt(priceInput.value) || '';
    
    document.getElementById('price-value').innerText = price === '' ? '？' : price;
    document.getElementById('price-value-display').innerText = price === '' ? '？' : price;
    updateTotalPrice();
}

function updateQuantityDisplay() {
    const quantityInput = document.getElementById('quantity');
    const quantity = quantityInput.value === '' ? '' : parseInt(quantityInput.value) || '';
    
    document.getElementById('quantity-value').innerText = quantity === '' ? '？' : quantity;
    document.getElementById('quantity-value-display').innerText = quantity === '' ? '？' : quantity;
    updateTotalPrice();
}

function updateTotalPrice() {
    const priceInput = document.getElementById('price');
    const quantityInput = document.getElementById('quantity');
    const price = priceInput.value === '' ? 0 : parseInt(priceInput.value) || 0;
    const quantity = quantityInput.value === '' ? 0 : parseInt(quantityInput.value) || 0;
    const total = price * quantity;
    const el = document.getElementById('total-price-display');
    
    if (priceInput.value === '' || quantityInput.value === '') {
        el.innerText = '？';
        el.className = 'text-muted font-weight-bold';
    } else {
        el.innerText = total;
        const direction = document.getElementById('selected-direction').value;
        if (direction === 'buy') {
            const cash = parseInt(document.getElementById('cash').innerText);
            el.className = total > cash
                ? 'text-warning font-weight-bold'
                : 'text-success font-weight-bold';
        } else {
            el.className = 'text-success font-weight-bold';
        }
    }
}

/** 提交掛單 - 修復：統一使用 submit_offer **/
function submitOffer() {
    if (isProcessingAction) return false;
    
    const priceInput = document.getElementById('price');
    const quantityInput = document.getElementById('quantity');
    
    if (priceInput.value === '' || parseInt(priceInput.value) < 1) {
        showStatus('請輸入有效的價格（正整數）', 'warning', 3000);
        priceInput.focus();
        return false;
    }
    
    if (quantityInput.value === '' || parseInt(quantityInput.value) < 1) {
        showStatus('請輸入有效的數量（正整數）', 'warning', 3000);
        quantityInput.focus();
        return false;
    }
    
    const dir = document.getElementById('selected-direction').value;
    const price = parseInt(priceInput.value);
    const quantity = parseInt(quantityInput.value);

    log(`嘗試提交掛單: ${dir}, 價格 ${price}, 數量 ${quantity}`);
    log(`當前資源: 現金=${document.getElementById('cash').innerText}, 物品=${document.getElementById('items').innerText}`);

    // 資源檢查
    if (dir === 'buy' && price * quantity > parseInt(document.getElementById('cash').innerText)) {
        showStatus(`單一買單金額不能超過持有現金！需要 ${price * quantity}，但您只有 ${document.getElementById('cash').innerText}`, 'warning', 5000);
        return false;
    }
    
    if (dir === 'sell' && parseInt(document.getElementById('items').innerText) < quantity) {
        const currentItems = parseInt(document.getElementById('items').innerText);
        showStatus(`{{ item_name }}不足！您想要賣出 ${quantity} 個{{ item_name }}，但目前只持有 ${currentItems} 個{{ item_name }}。請調整賣出數量。`, 'warning', 5000);
        
        if (currentItems > 0) {
            document.getElementById('quantity').value = currentItems;
            updateQuantityDisplay();
            showStatus(`已自動調整賣出數量為您的持有量：${currentItems} 個{{ item_name }}`, 'info', 3000);
        }
        return false;
    }

    log(`資源檢查通過，提交掛單: ${dir}, 價格 ${price}, 數量 ${quantity}`);
    showStatus('處理掛單中...', 'info');
    isProcessingAction = true;
    submitBtn.disabled = true;

    // 修復：統一使用 submit_offer
    const requestData = { type:'submit_offer', direction: dir, price, quantity };
    log(`發送請求: ${JSON.stringify(requestData)}`);
    liveSend(requestData);
    
    setTimeout(() => {
        if (isProcessingAction) {
            submitBtn.disabled = false;
            isProcessingAction = false;
            showStatus('伺服器無回應，請重試', 'warning', 3000);
            log('提交掛單超時，重設狀態');
        }
    }, 5000);
    return false;
}

/** 接受掛單 - 修復：統一參數名稱 **/
function acceptOffer(type, pid, price, qty) {
    if (isProcessingAction) return false;
    
    if (pid == playerId) {
        showStatus('不能與自己交易！', 'danger', 3000);
        return false;
    }
    
    log(`嘗試接受掛單: ${type}, 玩家 ${pid}, 價格 ${price}, 數量 ${qty}`);
    log(`當前資源: 現金=${document.getElementById('cash').innerText}, 物品=${document.getElementById('items').innerText}`);
    
    // 資源檢查
    if (type === 'sell' && price * qty > parseInt(document.getElementById('cash').innerText)) {
        showStatus(`現金不足！需要 ${price * qty}，但您只有 ${document.getElementById('cash').innerText}`, 'warning', 5000);
        return false;
    }
    
    if (type === 'buy'  && parseInt(document.getElementById('items').innerText) < qty) {
        const currentItems = parseInt(document.getElementById('items').innerText);
        showStatus(`{{ item_name }}不足！您想要賣出 ${qty} 個{{ item_name }}，但目前只持有 ${currentItems} 個{{ item_name }}。無法接受此買單。`, 'warning', 5000);
        return false;
    }
    
    log(`資源檢查通過，接受掛單: ${type}, 玩家 ${pid}, 價格 ${price}, 數量 ${qty}`);
    showStatus('處理交易中...', 'info');
    isProcessingAction = true;
    document.querySelectorAll('.btn').forEach(b => b.disabled = true);
    
    // 修復：統一參數名稱
    const requestData = { type:'accept_offer', offer_type: type, player_id: pid, price, quantity: qty };
    log(`發送請求: ${JSON.stringify(requestData)}`);
    liveSend(requestData);
    
    setTimeout(() => {
        if (isProcessingAction) {
            document.querySelectorAll('.btn').forEach(b => b.disabled = false);
            isProcessingAction = false;
            showStatus('伺服器無回應，請重試', 'warning', 3000);
            log('接受掛單超時，重設狀態');
        }
    }, 5000);
    return false;
}

/** 取消掛單 - 修復：統一使用 cancel_offer **/
function cancelOffer(dir, price, qty) {
    if (isProcessingAction) return false;
    
    log(`嘗試取消掛單: ${dir}, 價格 ${price}, 數量 ${qty}`);
    
    showStatus('取消掛單中...', 'info');
    isProcessingAction = true;
    document.querySelectorAll('.btn').forEach(b => b.disabled = true);
    
    // 修復：統一使用 cancel_offer
    const requestData = { type:'cancel_offer', direction: dir, price, quantity: qty };
    log(`發送請求: ${JSON.stringify(requestData)}`);
    liveSend(requestData);
    
    setTimeout(() => {
        if (isProcessingAction) {
            document.querySelectorAll('.btn').forEach(b => b.disabled = false);
            isProcessingAction = false;
            showStatus('伺服器無回應，請重試', 'warning', 3000);
            log('取消掛單超時，重設狀態');
        }
    }, 5000);
    return false;
}

/** 處理 oTree 回傳 - 修復：統一數據處理邏輯 **/
function processOtreeResponse(data) {
    try {
        log(`接收原始數據: ${JSON.stringify(data).slice(0,200)}...`);
        
        // 重置處理狀態
        if (isProcessingAction) {
            isProcessingAction = false;
            log('收到回應，重置處理狀態');
        }
        
        let playerData = null;
        
        // 嘗試從回應中提取玩家數據
        if (data[playerId]) { 
            playerData = data[playerId];
            log(`找到玩家 ${playerId} 的數據`);
        } else if (data.type === 'update' || data.type === 'market_update') { 
            playerData = data;
            log(`找到更新類型數據`);
        } else if (data.cash !== undefined && data.items !== undefined) {
            playerData = data;
            log('直接使用數據');
        } else {
            for (const k in data) {
                if (data[k] && (data[k].type || (data[k].cash !== undefined && data[k].items !== undefined))) { 
                    playerData = data[k];
                    log(`在鍵 ${k} 找到數據`);
                    break;
                }
            }
        }
        
        if (!playerData) {
            log('未找到有效的玩家數據');
            if (isProcessingAction) {
                isProcessingAction = false;
                document.querySelectorAll('.btn').forEach(b => b.disabled = false);
                showStatus('數據接收異常，請重試', 'danger', 3000);
            }
            return false;
        }
        
        // 檢查是否為錯誤回應
        if (playerData.type === 'error') {
            log(`收到錯誤回應: ${playerData.message}`);
            if (isProcessingAction) {
                isProcessingAction = false;
                document.querySelectorAll('.btn').forEach(b => b.disabled = false);
            }
            showStatus(playerData.message || '操作失敗，請重試', 'danger', 5000);
            if (playerData.cash !== undefined) {
                document.getElementById('cash').innerText = playerData.cash;
            }
            if (playerData.items !== undefined) {
                document.getElementById('items').innerText = playerData.items;
            }
            return true;
        }
        
        // 處理通知
        if (playerData.notifications && playerData.notifications[playerId]) {
            const message = playerData.notifications[playerId];
            let alertType = 'info';
            
            if (playerData.type === 'fail') {
                alertType = 'danger';
            } else if (playerData.type === 'trade_executed') {
                alertType = 'success';
            }
            
            showStatus(message, alertType, 5000);
            log(`顯示通知: [${alertType}] ${message}`);
        } else if (playerData.notification) {
            let notificationType = playerData.notification.type || 'info';
            if (notificationType === 'error') {
                notificationType = 'danger';
            }
            showStatus(playerData.notification.message, notificationType, 5000);
        }
        
        // 更新顯示資源
        if (playerData.cash !== undefined) {
            document.getElementById('cash').innerText = playerData.cash;
        }
        
        if (playerData.items !== undefined) {
            document.getElementById('items').innerText = playerData.items;
            // 更新總價值顯示
            const totalItemValue = playerData.items * personalItemValue;
            document.getElementById('total-item-value').innerText = totalItemValue;
            document.getElementById('items-display').innerText = playerData.items;
        }
        
        updateSellButtonState();

        // 更新我的買單列表
        const myBuyTb = document.querySelector('#my-buy-orders-body');
        myBuyTb.innerHTML = '';
        if (playerData.my_buy_offers && playerData.my_buy_offers.length) {
            playerData.my_buy_offers.forEach(o => {
                const row = document.createElement('tr');
                
                const c1 = document.createElement('td');
                c1.textContent = o.price;
                c1.className = 'text-success font-weight-bold';
                row.appendChild(c1);
                
                const c3 = document.createElement('td');
                c3.textContent = o.quantity;
                row.appendChild(c3);
                
                const tp = o.price * o.quantity;
                const c2 = document.createElement('td');
                c2.textContent = tp;
                c2.className = 'text-primary';
                row.appendChild(c2);
                
                const c4 = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = 'btn btn-danger btn-sm';
                btn.textContent = '取消';
                btn.onclick = e => { e.preventDefault(); cancelOffer('buy', o.price, o.quantity); };
                c4.appendChild(btn);
                row.appendChild(c4);
                
                myBuyTb.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.textContent = '目前沒有買單';
            cell.className = 'text-center text-muted';
            row.appendChild(cell);
            myBuyTb.appendChild(row);
        }

        // 更新我的賣單列表
        const mySellTb = document.querySelector('#my-sell-orders-body');
        mySellTb.innerHTML = '';
        if (playerData.my_sell_offers && playerData.my_sell_offers.length) {
            playerData.my_sell_offers.forEach(o => {
                const row = document.createElement('tr');
                
                const c1 = document.createElement('td');
                c1.textContent = o.price;
                c1.className = 'text-danger font-weight-bold';
                row.appendChild(c1);
                
                const c3 = document.createElement('td');
                c3.textContent = o.quantity;
                row.appendChild(c3);
                
                const tp = o.price * o.quantity;
                const c2 = document.createElement('td');
                c2.textContent = tp;
                c2.className = 'text-primary';
                row.appendChild(c2);
                
                const c4 = document.createElement('td');
                const btn = document.createElement('button');
                btn.className = 'btn btn-danger btn-sm';
                btn.textContent = '取消';
                btn.onclick = e => { e.preventDefault(); cancelOffer('sell', o.price, o.quantity); };
                c4.appendChild(btn);
                row.appendChild(c4);
                
                mySellTb.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.textContent = '目前沒有賣單';
            cell.className = 'text-center text-muted';
            row.appendChild(cell);
            mySellTb.appendChild(row);
        }

        // 更新買單列表 (公共)
        const buyTb = document.querySelector('#buy-offers tbody');
        buyTb.innerHTML = '';
        if (playerData.buy_offers && playerData.buy_offers.length) {
            playerData.buy_offers.forEach(o => {
                const row = document.createElement('tr');
                
                const c1 = document.createElement('td');
                c1.textContent = o.price;
                c1.className = 'text-success font-weight-bold';
                row.appendChild(c1);
                
                const c3 = document.createElement('td');
                c3.textContent = o.quantity;
                row.appendChild(c3);
                
                const tp = o.price * o.quantity;
                const c2 = document.createElement('td');
                c2.textContent = tp;
                c2.className = 'text-primary';
                row.appendChild(c2);
                
                const c4 = document.createElement('td');
                
                if (o.player_id != playerId) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-success btn-sm';
                    btn.textContent = '賣出';
                    btn.onclick = e => { e.preventDefault(); acceptOffer('buy', o.player_id, o.price, o.quantity); };
                    c4.appendChild(btn);
                } else {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-secondary';
                    badge.textContent = '我的掛單';
                    c4.appendChild(badge);
                }
                
                row.appendChild(c4);
                buyTb.appendChild(row);
            });
        }
        
        if (!buyTb.hasChildNodes()) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.textContent = '目前沒有買單';
            cell.className = 'text-center text-muted';
            row.appendChild(cell);
            buyTb.appendChild(row);
        }

        // 更新賣單列表 (公共)
        const sellTb = document.querySelector('#sell-offers tbody');
        sellTb.innerHTML = '';
        if (playerData.sell_offers && playerData.sell_offers.length) {
            playerData.sell_offers.forEach(o => {
                const row = document.createElement('tr');
                
                const c1 = document.createElement('td');
                c1.textContent = o.price;
                c1.className = 'text-danger font-weight-bold';
                row.appendChild(c1);
                
                const c3 = document.createElement('td');
                c3.textContent = o.quantity;
                row.appendChild(c3);
                
                const tp = o.price * o.quantity;
                const c2 = document.createElement('td');
                c2.textContent = tp;
                c2.className = 'text-primary';
                row.appendChild(c2);
                
                const c4 = document.createElement('td');
                
                if (o.player_id != playerId) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-success btn-sm';
                    btn.textContent = '買入';
                    btn.onclick = e => { e.preventDefault(); acceptOffer('sell', o.player_id, o.price, o.quantity); };
                    c4.appendChild(btn);
                } else {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-secondary';
                    badge.textContent = '我的掛單';
                    c4.appendChild(badge);
                }
                
                row.appendChild(c4);
                sellTb.appendChild(row);
            });
        }
        
        if (!sellTb.hasChildNodes()) {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.textContent = '目前沒有賣單';
            cell.className = 'text-center text-muted';
            row.appendChild(cell);
            sellTb.appendChild(row);
        }
        
        // 更新交易歷史
        const historyTb = document.querySelector('#trade-history-body');
        historyTb.innerHTML = '';
        if (playerData.trade_history && playerData.trade_history.length) {
            const sortedHistory = [...playerData.trade_history].sort((a, b) => {
                const timeA = a.timestamp || a.time || 0;
                const timeB = b.timestamp || b.time || 0;
                return typeof timeB === 'string' ? timeB.localeCompare(timeA) : timeB - timeA;
            });
            
            sortedHistory.forEach(trade => {
                const row = document.createElement('tr');
                
                const timeCell = document.createElement('td');
                if (trade.timestamp && typeof trade.timestamp === 'string' && trade.timestamp.match(/^\d{2}:\d{2}$/)) {
                    timeCell.textContent = trade.timestamp;
                } else if (trade.time) {
                    timeCell.textContent = trade.time;
                } else if (typeof trade.timestamp === 'number') {
                    try {
                        const elapsedSeconds = trade.timestamp - startTime;
                        if (elapsedSeconds >= 0) {
                            const minutes = Math.floor(elapsedSeconds / 60);
                            const seconds = elapsedSeconds % 60;
                            timeCell.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        } else {
                            timeCell.textContent = new Date(trade.timestamp * 1000).toLocaleTimeString();
                        }
                    } catch (e) {
                        timeCell.textContent = "時間格式錯誤";
                        log(`時間格式錯誤: ${trade.timestamp}, ${e.message}`);
                    }
                } else {
                    timeCell.textContent = "未知時間";
                }
                timeCell.className = 'small';
                row.appendChild(timeCell);
                
                const priceCell = document.createElement('td');
                priceCell.textContent = trade.price;
                priceCell.className = 'font-weight-bold';
                row.appendChild(priceCell);
                
                const quantityCell = document.createElement('td');
                quantityCell.textContent = trade.quantity;
                row.appendChild(quantityCell);
                
                const typeCell = document.createElement('td');
                
                if (trade.buyer_id == playerId) {
                    typeCell.textContent = '買入';
                    typeCell.className = 'text-success font-weight-bold';
                    row.className = 'table-success';
                } else if (trade.seller_id == playerId) {
                    typeCell.textContent = '賣出';
                    typeCell.className = 'text-danger font-weight-bold';
                    row.className = 'table-danger';
                } else {
                    typeCell.textContent = '其他交易';
                    typeCell.className = 'text-muted';
                    row.className = 'table-light';
                }
                row.appendChild(typeCell);
                
                historyTb.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 4;
            cell.textContent = '尚無交易記錄';
            cell.className = 'text-center text-muted';
            row.appendChild(cell);
            historyTb.appendChild(row);
        }

        return true;

    } catch (error) {
        log(`處理回傳錯誤: ${error.message}`);
        showStatus(`更新失敗: ${error.message}`, 'danger', 5000);
        isProcessingAction = false;
        return false;
    }
}

/** WebSocket 接收 **/
window.liveRecv = function(data) {
    document.querySelectorAll('.btn').forEach(b => b.disabled = false);
    
    if (!data || typeof data !== 'object') {
        log('收到無效數據格式');
        showStatus('伺服器返回數據格式錯誤，正在重試...', 'warning', 2000);
        setTimeout(() => liveSend({ type: 'ping' }), 2000);
        return false;
    }
    
    if (!processOtreeResponse(data)) {
        log('數據處理失敗，嘗試重新獲取');
        showStatus('正在同步交易資料...', 'info', 2000);
        setTimeout(() => liveSend({ type: 'ping' }), 2000);
    }
    
    return false;
};

/** 首次載入與定時 ping **/
window.addEventListener('load', e => {
    e.preventDefault();
    log('頁面載入，發送 ping');
    showStatus('正在連接交易系統...', 'info');
    setTimeout(() => liveSend({ type: 'ping' }), 500);
    updatePriceDisplay();
    updateQuantityDisplay();
    updateTotalPrice();
    updateSellButtonState();
    setupInputValidation();
    return false;
});

setInterval(() => {
    if (!isProcessingAction) {
        liveSend({ type: 'ping' });
    }
}, 15000);

/** 禁用原生表單提交與連結 **/
document.addEventListener('submit', e => { e.preventDefault(); return false; });
document.addEventListener('click', e => {
    const t = e.target;
    if ((t.tagName==='A'||t.parentElement.tagName==='A') && !t.href.includes('/admin/')&& !t.href.includes('/logout/')) {
        e.preventDefault();
        return false;
    }
});

function setupInputValidation() {
    const priceInput = document.getElementById('price');
    const quantityInput = document.getElementById('quantity');
    
    priceInput.addEventListener('blur', function() {
        if (this.value !== '' && parseInt(this.value) < 1) {
            this.value = '';
            updatePriceDisplay();
        }
    });
    
    quantityInput.addEventListener('blur', function() {
        if (this.value !== '' && parseInt(this.value) < 1) {
            this.value = '';
            updateQuantityDisplay();
        }
    });
}
</script>

{% endblock %}
